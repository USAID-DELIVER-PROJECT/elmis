<!--
  ~ Electronic Logistics Management Information System (eLMIS) is a supply chain management system for health commodities in a developing country setting.
  ~
  ~ Copyright (C) 2015  John Snow, Inc (JSI). This program was produced for the U.S. Agency for International Development (USAID). It was prepared under the USAID | DELIVER PROJECT, Task Order 4.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->

<div class="alert alert-success" id="saveSuccessMsgDiv" ng-bind="message" ng-show="message"></div>
<div class="row-fluid sortable ui-sortable">
    <div class="box span12">
      <div class="box-header" id="report-head">
            <h2>
                <span openlmis-message="report.title.daily.consumption.report"></span>
            </h2>
            <div class="box-icon">
                <!--<a style="" id="pdf-button" ng-show="filterForm.$valid" href="" ng-click="exportReport('PDF')"-->
                   <!--class='btn-small btn-info'><span openlmis-message="label.pdf"></span></a>-->
                <!--<a id="xls-button" ng-show="filterForm.$valid" href="" ng-click="exportReport('XLS')"-->
                   <!--class='btn-small btn-info'><span openlmis-message="label.excel"></span></a>-->
            </div>
        </div>
        <div class="row-fluid">
            <div class="sidebar">
                <div class="app-form" style="padding: 5px;">
                    <form ng-submit="filterGrid()" name="filterForm" novalidate>
                        <div class="clearfix">
                            <filter-container no-required-param="true">
                                <program-filter class="form-cell horizontalFilters"></program-filter>
                                <zone-filter class="form-cell horizontalFilters"></zone-filter>
                                <div style="margin-top: 10px;"  class="form-cell horizontalFilters">
								<label  openlmis-message="label.date"></label>
								
                               <input
                   name="searchDate"
                   type="text"
                   ui-date="{dateFormat: 'dd/mm/yy', changeYear: true, maxDate:'today'}"
                   ng-model="filter.date"
                   ui-date-format="yy-mm-dd"/>
                              </div>


                                <facility-type-filter class="form-cell horizontalFilters"></facility-type-filter>
                                <facility-owner-filter class="form-cell horizontalFilters"></facility-owner-filter>
                                <facility-filter class="form-cell horizontalFilters"></facility-filter>
                                <product-category-filter class="form-cell horizontalFilters"></product-category-filter>
                                <product-filter class="form-cell horizontalFilters"></product-filter>
                            </filter-container>

                            <span class="pull-right"><a ng-click="searchReport()" class="waves-effect waves-light btn">Search</a>
                        </div>
                    </form>
                    <div style="margin:2px !important;font-size:10px;" ng-show="perioderror" class="row">
                        <div class="span11 ">
                            <p style="background-color: #EC4F67;color: #fff;font-size: 11px;">{{perioderror}}</p>
                        </div>
                    </div>
                </div>

            </div>
            <div class="content-body">
                <div class="row-fluid">

                    <div class="span12 ">
                        <div>
                            <div class="box-header">


                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="emergency"><input id="emergency" class="checkbox" type="checkbox" value="false"
                                                                      ng-change="aggregateReport()" ng-model="aggregated">
                                            <span openlmis-message="label.report.view.aggregated"></span>
                                        </label>
                                    </div>
                                </div>


                            </div>
                            <div class="box-header">

                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="all"><input id="all" class="checkbox" type="checkbox" value="ALL"
                                                                ng-change="onToggleAll()" ng-model="all">
                                            <span openlmis-message="label.all"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="so"><input ng-checked="true" id="so" class="checkbox" type="checkbox" value="SO"
                                                               ng-change="toggle()" ng-model="reportType.so">
                                            <span openlmis-message="SO"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="us"><input id="us" class="checkbox" type="checkbox" value="US"
                                                               ng-change="toggle()" ng-model="reportType.us">
                                            <span  openlmis-message="US"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="sp">
                                            <input id="sp" class="check-box" type="checkbox" value="SP"
                                                   ng-change="toggle()" ng-model="reportType.as">
                                            <span openlmis-message="SP"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="os"><input id="os" class="checkbox" type="checkbox" value="OS"
                                                               ng-change="toggle()" ng-model="reportType.os">
                                            <span openlmis-message="OS"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-cell span2">
                                    <div class="checkbox">
                                        <label for="uk"><input id="uk" class="checkbox" type="checkbox" value="UK"
                                                               ng-change="toggle()" ng-model="reportType.uk">
                                            <span openlmis-message="label.no.demand"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table client-side-sort-pagination class="table table-bordered"
                               ng-show="data == undefined || data.length == 0">
                            <tr>
                                <td>No data to show under selected filters</td>
                            </tr>
                        </table>
                        <div ng-show="datarows.length > 0">
                            <div ng-if="datarows.length > 0" top-right-table-summary></div>
                            <table ng-show="datarows.length > 0" class="table-bordered table table-striped pull-right"
                                   ng-table="tableParams">
                                <tr>
                                    <th  >#</th>
                                    <th ng-if="aggregated==undefined||!aggregated"  openlmis-message="label.facility.code"></th>
                                    <th ng-if="aggregated==undefined||!aggregated"  openlmis-message="label.facility.name"></th>
                                    <th  ng-if="aggregated==undefined||!aggregated||geoLevel.code!=='Country'"  openlmis-message="label.district"></th>
                                    <th  openlmis-message="label.zone"></th>
                                    <th  openlmis-message="label.daily.requisition.first.submission"></th>
                                    <th  openlmis-message="label.daily.requisition.last.submission"></th>
                                </tr>

                                <tbody>
                                <tr ng-repeat-start="row in filtered">
                                    <td class="number" style="width:40px">
                                        <a ng-if="row.collapsed===undefined||row.collapsed===true" ng-click=" row.collapsed=false ">
                                            <span ><i class="fa fa-plus"></i></span>
                                            &nbsp;&nbsp;{{ row.no }}
                                        </a>
                                        <a ng-if="row.collapsed!==undefined&&row.collapsed===false" ng-click=" row.collapsed=true">
                                            <span ><i class="fa fa-minus"></i></span>
                                            &nbsp;&nbsp;{{ row.no }}
                                        </a>
                                       </td>

                                    <td ng-if="aggregated==undefined||!aggregated" style="width:80px" "
                                        sortable="facilityCode">{{ row.facilityCode }}
                                    </td>
                                    <td  ng-if="aggregated==undefined||!aggregated" style="width:150px"
                                               sortable="facilityName">{{ row.facility }}
                                </td>
                                    <td  ng-if="aggregated==undefined||!aggregated||geoLevel.code!=='Country'" style="width:150px"
                                        sortable="district">{{ row.district}}
                                    </td>
                                    <td style="width:150px"
                                        sortable="province">{{row.province }}
                                    </td>
                                    <td style="width:120px"
                                        sortable="submission">{{ row.fistSubmissionDate | date : 'dd MMM, yyyy' }}
                                    </td>
                                    <td style="width:80px"
                                        sortable="daysAfterLastSubmission">
                                        {{ row.lastSubmissionDate | date : 'dd MMM, yyyy' }}
                                    </td>



                                </tr>

                                <tr ng-repeat-end ng-show="row.collapsed!==undefined&&row.collapsed===false && row.lineItems.length>0" >
                                    <td ng-if="aggregated===undefined||!aggregated"  colspan="9" class="sub-report">
                                        <table>
                                            <thead>

                                            <tr>
                                                <th rowspan="2" openlmis-message="label.report.product.code"></th>
                                                <th rowspan="2" openlmis-message="rnr.header.product.name"></th>
                                                <th colspan="4" openlmis-message="label.previous.period.soh"></th>
                                                <th colspan="3" openlmis-message="label.current.stock.status"></th>

                                            </tr>
                                            <tr>
                                                <th openlmis-message="label.ivd.form.period"></th>
                                                <th openlmis-message="label.amc"></th>
                                                <th openlmis-message="label.mos"></th>
                                                <th openlmis-message="header.status.soh"></th>

                                                <th  openlmis-message="header.status.soh"></th>
                                                <th openlmis-message="label.status"></th>
                                                <th   openlmis-message="label.daily.requisition.last.submission"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr  ng-repeat="p in row.lineItems">
                                                <td>{{ p.productCode }}</td>
                                                <td>{{ p.name }}</td>
                                                <td class="current-column">{{ p.periodName}}</td>
                                                <td class="current-column">{{p.amc}}</td>
                                                <td class="current-column">{{p.mos}}</td>
                                                <td class="current-column"><span>{{ p.stockOnHand }}</span></td>
                                                <td>{{ p.stockOnDate }}</td>
                                                                          <td>
                                                    <div
                                                            class="{{(p.dailyStatus == 'SO')?'red':(p.dailyStatus=='SP')?'green':(p.dailyStatus=='OS')?'blue':'yellow'}}">
                      <span ng-show="p.amc == 0 || p.dailyStatus == 'UK'" class="icon-warning-sign"
                            tooltip="AMC is 0, which indicates that there may not be enough data to interpret this status."></span>
                                                        {{ (p.dailyStatus == 'SO') ?
                                                        'Stocked Out' :
                                                        (p.dailyStatus=='SP') ?
                                                        'Adequately Stocked' : (p.dailyStatus=='OS') ? 'Over Stocked' : (p.dailyStatus =='US') ? 'Under Stocked' : 'No Demand (AMC=0)' }}
                                                    </div>
                                                </td>
                                                <td style="width:80px" ng-class="{'after-recent-date':p.dif>0,'before-recent-date':p.dif<0}"
                                                    >
                                                   {{ p.recentDate | date : 'dd MMM, yyyy' }}
                                                </td>
                                            </tr>

                                            </tbody>
                                        </table>
                                    </td>
                                    <td ng-if="aggregated"  colspan="9" class="sub-report">
                                        <table>
                                            <thead>

                                            <tr>
                                                <th rowspan="2" openlmis-message="label.report.product.code"></th>
                                                <th rowspan="2" openlmis-message="rnr.header.product.name"></th>
                                                <!--<th colspan="4" openlmis-message="label.previous.period.soh"></th>-->
                                                <th colspan="3" openlmis-message="label.current.stock.status"></th>

                                            </tr>
                                            <tr style="height: 30px">
                                                <!--<th openlmis-message="label.ivd.form.period"></th>-->
                                                <!--<th openlmis-message="label.amc"></th>-->
                                                <!--<th openlmis-message="label.mos"></th>-->
                                                <!--<th openlmis-message="header.status.soh"></th>-->
                                                <th  openlmis-message="header.status.soh"></th>
                                                <th openlmis-message="label.status"></th>

                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr   ng-repeat="p in row.aggregateItems">
                                                <td>{{ p.productCode }}</td>
                                                <td>{{ p.name }}</td>

                                                <td>{{ p.stockOnDate }}</td>
                                                <td>
                                                    <div
                                                            class="{{(p.dailyStatus == 'SO')?'red':(p.dailyStatus=='SP')?'green':(p.dailyStatus=='OS')?'blue':'yellow'}}">
                      <span ng-show="p.amc == 0 || p.dailyStatus == 'UK'" class="icon-warning-sign"
                            tooltip="AMC is 0, which indicates that there may not be enough data to interpret this status."></span>
                                                        {{ (p.dailyStatus == 'SO') ?
                                                        'Stocked Out' :
                                                        (p.dailyStatus=='SP') ?
                                                        'Adequately Stocked' : (p.dailyStatus=='OS') ? 'Over Stocked' : (p.dailyStatus =='US') ? 'Under Stocked' : 'No Demand (AMC=0)' }}
                                                    </div>
                                                </td>
                                            </tr>

                                            </tbody>
                                        </table>
                                    </td>
                                </tr>


                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sub-report {
        background-color: #d9d9d9;
    }

    .sub-report table{
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }

    .sub-report table tr td{
        background-color:#f9f9f9;
    }

  td .current-column{
       background-color: #ebebeb !important;
   }
    .prev-column{

    }
    .after-recent-date{

       color: #58ee2e !important;
    }
    .before-recent-date{
        color: #ff3616 !important;

    }
</style>
